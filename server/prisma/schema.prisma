// prisma/schema.prisma

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =====================
   ENUMS
===================== */

enum Role {
  ADMIN
  STUDENT
}

/* =====================
   USER
===================== */

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique  
  password  String   // hash in production
  role      Role     @default(STUDENT)

  quizzes   Quiz[]        // quizzes created (admin)
  attempts  QuizAttempt[] // quizzes attempted (student)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/* =====================
   QUIZ
===================== */

model Quiz {
  id          String   @id @default(cuid())
  title       String
  description String?

  createdBy   String
  creator     User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  questions   Question[]
  attempts    QuizAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/* =====================
   QUESTION
===================== */

model Question {
  id        String   @id @default(cuid())
  text      String
  order     Int

  quizId    String
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  options   Option[]
  answers   Answer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/* =====================
   OPTION
===================== */

model Option {
  id         String   @id @default(cuid())
  text       String
  isCorrect  Boolean  @default(false)
  order      Int

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  answers    Answer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/* =====================
   QUIZ ATTEMPT
===================== */

model QuizAttempt {
  id             String   @id @default(cuid())
  score          Int
  totalQuestions Int

  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  quizId   String
  quiz     Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  answers  Answer[]

  submittedAt DateTime @default(now())
}

/* =====================
   ANSWER
===================== */

model Answer {
  id         String   @id @default(cuid())

  attemptId  String
  attempt    QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  questionId String
  question   Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  optionId   String
  option     Option      @relation(fields: [optionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  // One answer per question per attempt
  @@unique([attemptId, questionId])
}
